<b><font color=FF9033>系统故障处理主要包括保留现场、恢复、定位、解决、复盘五个步骤。</font></b>

1. 保留现场

    保留现场最重要的一件事，是保存异常程序的Dump文件。此外，如果系统的监控体系并不完备的话，还需要将问题发生时，操作系统、各第三方组件自带的监控数据快速地通过截图保存下来。保存监控数据的时候，要特别留意一下网络相关的数据。如果发现网络相关的数据有异常，那么再把当下的网络连接情况通过命令保存下来。因为相对来说，网络出现问题的概率远远大于硬件，规模越大的系统，越是如此。

2. 恢复

    最常用的方法就是重启，这个方法几乎适用于 80% 的情况。而重启又分为自然重启和强制重启，在遇到故障时，应优先考虑自然重启，这样能避免产生一些意料之外的脏数据。但如果是系统出现资源耗用异常的话，就不要傻傻地等自然重启了，只能强制重启。

    

    第二种常见的恢复方法是**回滚**。使用回滚的前提条件是，故障与最近一次发布有关。反正，盲目的回滚不但起不到作用，还会越弄越乱，特别是在分布式系统中。因为在分布式系统中，一旦上下游耦合的地方出现对接不上的情况，轻则报错，重则出现大量的异常数据。

    

    第三种常见的恢复方法是**降级**，暂停出问题的模块，停止服务。当然，这个动作需要和业务方做好沟通，避免出现单独降级某个模块导致业务不完整之类的问题。

    

    第四种常见的恢复方法是**限流或者扩容**。如果你发现是系统扛不住突增的流量，而导致发生故障的话，可以快速扩容几台机器和程序。无法扩容的话，可以选择限流，将一定百分比的请求直接拒绝服务。毕竟所有请求无法提供服务和部分请求无法提供服务相比，肯定还是后者划算。

    

    除了以上四种方法，还有一些比较小众的方法是切到备机、故障隔离等

3. 定位

    通过Dump文件、监控数据、日志层层分析来定位问题。

4. 解决

5. 复盘

    你一定知道复盘的种种好处，但在实际操作中，却很少真正地自己进行复盘。如果你不知道从何下手来做复盘的话，不妨从以下几个问题入手：

    - 这次故障原因是什么？
    - 在当时是否有更快的方式来恢复业务？
    - 如何避免再出现类似故障？
    - 当前系统中是否还有类似的潜在风险？

    如果你能回答这些问题，那么这个复盘就很到位了

# 踩界

踩内存就是对不属于你的内存进行读写，访问了不应该访问的内存，常见有几种：

1. 越界踩。越界踩的意思就是踩坏的内存就在你分配内存的旁边，也就是在界限附近，出现这种情况一般是由于申请的内存小了。举个例子：

    ```C++
    char *p;
    p = malloc(5);strcpy(p, "hello");
    ```

    `strcpy`拷贝了6个字节（字符串“hello”有6个字节，包括最后的‘\0’）,但是指针p指向所分配的内存只有5个字节，所以就越界了。

2. 数组越界，也属于一种越界踩，除此之外，越界踩还有一种比较难发现的情况，就是栈溢出的情况，我们知道栈内存一般都是有固定大小的，如果一个函数里面变量过多大就会导致栈溢出，出现越界踩。举个例子：

    ```C++
    int func() {
    	char tmp[1024000000000];
    	for (int i = 0; i < 1024000000; i++) {
            tmp = 'H';
        }
    }
    ```

3. Use After Free：指针在使用的之前又被释放掉，那么这块内存很有可能又被分配出去了。

    ```C++
    char *p = malloc(6);
    strcpy(p, "hello");
    free(p); // p内存被回收了
    strcpy(p, "world"); /* p内存很可能再次被分配出去, 这条语句直接把属于你的内存踩坏 */
    ```

4. 随机踩。如果出现随机踩的话，那么问题排查起来就比较头痛了，因为不知道是在程序的哪个位置出现问题，因为有可能每次出现问题的地方都不一样，下面简单列举一个例子：

    ```C++
    int func(int i) {
    	char tmp[10];
        tmp='H';
    }
    ```

    这种情况下变量i没有做范围检查有可能是负数有可能很大，所以每次踩坏的地方都不一样，还有一种情况即就是没有初始化。



为了避免出现这种低级bug，需要养成：

1. 入参一定要做边界检查，防止溢出。
2. 代码不要嵌套太深，在多线程多通道的场景下，很容易重复释放/申请资源
3. 不要定义过多的局部变量，数组，防止栈溢出，内核中栈的大小是8k吧。看情况使用`kmalloc`。
4. 释放了的资源及时置空。



## 参考资料

1. [面试|搬了这么久的砖，居然还不知道什么踩内存](https://zhuanlan.zhihu.com/p/142630371)
2. [Linux内核内存问题定位](https://hakurei.red/2021/04/13/Linux%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98%E5%AE%9A%E4%BD%8D/)
3. [内存问题难定位，那是因为你没用ASAN](http://www.ckzixun.com/jishuzixun/3633.html)
4. [定位多线程内存越界问题实践总结](https://www.cnblogs.com/sky-heaven/p/9242120.html)

# tcmalloc死锁

# 参考资料

1. [极客时间：系统出现故障怎么办？](https://time.geekbang.com/column/article/267760?screen=full)
2. [巧用工具提升无源码系统的性能和稳定性](https://www.infoq.cn/article/Ao7YRUrQxvS2t4j4AjC2)