# 线程池

## 避免任务队列争抢
线程池仅具备一个任务队列供多线程共用，在同一个线程池实例上，每当有线程调用`submit()`，就把新任务压入该队列。执行任务时，工作线程不断从这个任务队列弹出任务。任务队列的争抢随着处理任务的线程数增加而加剧，这会降低性能。即便我们利用无锁队列避开显式等待，仍然会产生缓存乒乓现象，导致浪费时间。

有一种方法可解决缓存乒乓：为每个线程配备独立的任务队列。各线程只在自己的队列上提交新任务，仅当线程自身的队列没有任务时，才会从全局队列领取任务。

[采用thread_local实现线程拥有独立的任务队列，当前线程无任务时去全局队列 实现](code/src/9.1_SimpleThreadPool3.cpp)

上述实现，可能会导致本地队列和全局队列中没有任务了，存在某个队列有大量任务等待调度，这样便出现了任务分配不均。解决这个问题的方式是：若全局队列和线程自身的局部队列都没有任务，便让线程从其他的队列窃取任务。

## 任务窃取
为每个线程配备独立的任务队列。各线程只在自己的队列上提交新任务，仅当线程自身的队列没有任务时，才会从全局队列领取任务。若全局队列和线程自身的局部队列都没有任务，便让线程从其他的队列窃取任务，来改善任务分配不均。
[窃取任务实现](code/src/9.1_SimpleThreadPool4.cpp)