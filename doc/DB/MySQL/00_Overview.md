# 安全
## InnoDB静态数据加密

InnoDB支持 file-per-table 表空间、通用表空间、`mysql`系统表空间、重做日志和撤消日志的静态数据加密。从 MySQL 8.0.16 开始，还支持为模式和通用表空间设置加密默认值，这允许 DBA 控制在模式和表空间中创建的表是否被加密。

`InnoDB`使用两层加密密钥架构，由主加密密钥和表空间密钥组成。当表空间被加密时，表空间密钥被加密并存储在表空间头中。当应用程序或经过身份验证的用户想要访问加密的表空间数据时，使用主加密密钥来解密表空间密钥。表空间密钥的解密版本永远不会改变，但可以根据需要更改主加密密钥(称为主密钥轮换)。

静态数据加密功能依赖于用于主加密密钥管理的密钥环组件或插件。所有 MySQL 版本都提供一个 `component_keyring_file`组件和 `keyring_file`插件，它们都将密钥环数据存储在服务器主机的本地文件中。MySQL 企业版提供额外的密钥环组件和插件：

- `component_keyring_encrypted_file`：将密钥环数据存储在服务器主机本地的加密、受密码保护的文件中。

- `keyring_encrypted_file`：将密钥环数据存储在服务器主机本地的加密、受密码保护的文件中。
- `keyring_okv`：用于与 KMIP 兼容的后端密钥环存储产品一起使用的 KMIP 1.1 插件。受支持的 KMIP 兼容产品包括集中式密钥管理解决方案，例如 Oracle Key Vault、Gemalto KeySecure、Thales Vormetric 密钥管理服务器和 Fornetix Key Orchestration。
- `keyring_aws`：与作为密钥生成后端的 Amazon Web Services 密钥管理服务(AWS KMS))通信，并使用本地文件进行密钥存储。
- `keyring_hashicorp`：与 HashiCorp Vault 通信以进行后端存储。

静态数据加密功能使用集中式密钥管理解决方案时，该功能称为 MySQL 企业透明数据加密 (TDE) 。静态数据加密功能支持AES 256基于块的加密算法。它使用电子密码本 (ECB) 块加密模式进行表空间密钥加密，使用密码块链接 (CBC) 块加密模式进行数据加密。



### 加密先决条件

1. 必须在启动时安装和配置密钥环组件或插件。早期加载确保组件或插件在 `InnoDB`存储引擎初始化之前可用。一次只能启用一个密钥环组件或插件。不支持启用多个密钥环组件或插件，结果可能与预期不同。
2. 加密生产数据时，确保采取措施防止丢失主加密密钥。如果主加密密钥丢失，存储在加密表空间文件中的数据将无法恢复。



### 使用

<b>模式和通用表空间定义加密默认值</b>

从MySQL 8.0.16开始， default_table_encryption系统变量定义模式和通用表空间的默认加密设置，可以为单个客户端连接或全局使用语法SET设置变量。

```sql
-- 全局启用默认架构和表空间加密：
SET GLOBAL default_table_encryption=ON;
```



模式的默认加密设置也可以`DEFAULT ENCRYPTION`在创建或更改模式时使用子句定义

```sql
CREATE SCHEMA test DEFAULT ENCRYPTION = 'Y';
```

如果创建模式时未指定DEFAULT ENCRYPTION，则采用default_table_encryption设置，否则使用当前指定的加密设置。默认情况下，表会继承创建它的架构或通用表空间的加密设置。

---



<b>File-Per-Table 表空间加密</b>

从 MySQL 8.0.16 开始，除非CREATE TABLE中指定ENCRYPTION启用加密，否则，file-per-table表空间继承创建表的模式的默认加密。

```sql
-- 启用加密
CREATE TABLE t1 (c1 INT) ENCRYPTION = 'Y';

-- 更改现有的file-per-tabl 表空间的加密
ALTER TABLE t1 ENCRYPTION = 'Y';
```

---



<b>通用表空间加密</b>

从 MySQL 8.0.16 开始，除非在CREATE TABLESPACE中指定ENCRYPTION，否则新创建的通用表空间加密由default_table_encryption确定。

```sql
-- 启用表空间加密
CREATE TABLESPACE `ts1` ADD DATAFILE 'ts1.ibd' ENCRYPTION = 'Y' Engine=InnoDB;

-- 更改现有通用表空间的加密
mysql> ALTER TABLESPACE ts1 ENCRYPTION = 'Y';
```



### 重做日志加密

与表空间数据一样，重做日志数据加密发生在重做日志数据写入磁盘时，解密发生在重做日志数据从磁盘读取时。一旦重做日志数据被读入内存，它就是未加密的形式。重做日志数据使用表空间加密密钥进行加密和解密。

innodb_redo_log_encrypt 使用配置选项启用/禁止重做日志数据加密，默认禁用重做日志加密。启用时，磁盘上存在的未加密重做日志页保持未加密状态，新重做日志页以加密形式写入磁盘。禁用时，磁盘上存在的加密重做日志页保持加密状态，新的重做日志页以未加密的形式写入磁盘。

从MySQL 8.0.30 开始，重做日志加密元数据（包括表空间加密密钥）存储在具有最新检查点 LSN 的重做日志文件的标头中。在 MySQL 8.0.30 之前，重做日志加密元数据（包括表空间加密密钥）存储在第一个重做日志文件 ( `ib_logfile0`) 的标头中。如果删除带有加密元数据的重做日志文件，重做日志加密将被禁用。

<b><font color=FF6133>一旦启用重做日志加密，在没有密钥环组件或插件或没有加密密钥的情况下不可能正常重启</font></b>，因为`InnoDB`必须能够在启动期间扫描重做页面，如果重做日志页面被加密，这是不可能的。如果没有密钥环组件或插件或加密密钥，则只能在没有重做日志 ( `SRV_FORCE_NO_LOG_REDO`) 的情况下强制启动。



### 撤消日志加密

与表空间数据一样，undo log 数据加密发生在undo log 数据写入磁盘时，解密发生在undo log 数据从磁盘读取时。一旦撤消日志数据被读入内存，它就是未加密的形式。撤消日志数据使用表空间加密密钥进行加密和解密。

innodb_undo_log_encrypt 使用配置选项启用/禁止撤消日志数据加密,默认情况下禁用。启用时，磁盘上存在的未加密撤消日志页保持未加密状态，新的撤消日志页以加密形式写入磁盘;禁用时，磁盘上存在的加密撤消日志页保持加密状态，新的撤消日志页以未加密的形式写入磁盘。

撤消日志加密元数据（包括表空间加密密钥）存储在撤消日志文件的标头中。



### 主密钥轮换

应定期轮换主加密密钥，并在您怀疑密钥已被泄露时进行轮换。主密钥轮换是一个原子的、实例级的操作。每次轮换主加密密钥时，MySQL 实例中的所有表空间密钥都会重新加密并保存回各自的表空间标头。作为原子操作，一旦启动旋转操作，所有表空间密钥的重新加密必须成功。如果主密钥轮换因服务器故障而中断，InnoDB则在服务器重新启动时向前滚动操作。<b>旋转主加密密钥只会更改主加密密钥并重新加密表空间密钥，它不会解密或重新加密关联的表空间数据。</b>

轮换主加密密钥需要`ENCRYPTION_KEY_ADMIN`特权。

```sql
-- 轮换主加密密钥
ALTER INSTANCE ROTATE INNODB MASTER KEY;
```

`ALTER INSTANCE ROTATE INNODB MASTER KEY`支持并发 DML。但是，它不能与表空间加密操作并发运行，并采用锁定来防止并发执行可能引起的冲突。如果`ALTER INSTANCE ROTATE INNODB MASTER KEY`操作正在运行，它必须在表空间加密操作可以继续之前完成，反之亦然。



### 加密和恢复

如果在加密操作期间发生服务器故障，则该操作会在服务器重新启动时前滚。对于一般表空间，加密操作在后台线程中从最后处理的页面恢复。

如果在主密钥轮换期间发生服务器故障， `InnoDB`则在服务器重新启动时继续操作。密钥环组件或插件必须在存储引擎初始化之前加载，以便在`InnoDB`初始化和恢复活动访问表空间数据之前，可以从表空间标头中检索解密表空间数据页所需的信息。

当`InnoDB`初始化和恢复开始时，主密钥轮换操作恢复。由于服务器故障，一些表空间密钥可能已经使用新的主加密密钥进行了加密。`InnoDB`从每个表空间头中读取加密数据，如果数据表明表空间密钥是使用旧主加密密钥加密的，`InnoDB`则从密钥环中检索旧密钥并使用它来解密表空间密钥。 `InnoDB`然后使用新的主加密密钥重新加密表空间密钥，并将重新加密的表空间密钥保存回表空间头。



### 导出加密表空间

表空间导出仅支持 file-per-table 表空间。导出加密表空间时， InnoDB生成用于加密表空间密钥的传输密钥，加密的表空间密钥和传输密钥存储在`tablespace_name.cfp`文件中。执行导入操作需要此文件和加密的表空间文件。导入时， InnoDB使用传输密钥解密 `tablespace_name.cfp` 文件中的表空间密钥。



# 参考资料

1. [Mysql:InnoDB静态数据加密](https://mysql.net.cn/doc/refman/8.0/en/innodb-data-encryption.html#innodb-schema-tablespace-encryption-default)

