# ClickHouse为什么那么快？

列式存储，使用了向量化引擎

1. 自下向上设计，从眼镜功能层面着手设计：
    - 我们将要使用的硬件水平是怎样的？包括CPU、内存、硬盘、网络等。
    - 在这样的硬件上，我们需要达到怎样的性能？包括延迟、吞吐量等。
    - 我们准备使用怎样的数据结构？包括String、HashTable、Vector等。
    - 选择的这些数据结构，在我们的硬件上会如何工作
2. 算法在前，抽象在后

> 在ClickHouse的底层实现中，经常会面对一些重复的场景，例如字符串子串查询、数组排序、使用HashTable等。如何才能实现性能的最大化呢？算法的选择是重中之重。以字符串为例，有一本专门讲解字符串搜索的书，名为“Handbook of Exact String Matching Algorithms”，列举了35种常见的字符串搜索算法。各位猜一猜ClickHouse使用了其中的哪一种？答案是一种都没有。这是为什么呢？因为性能不够快。在字符串搜索方面，针对不同的场景，ClickHouse最终选择了这些算法：
>
> - 对于常量，使用Volnitsky算法
> - 对于非常量，使用CPU的向量化执行SIMD，暴力优化
> - 正则匹配使用re2和hyperscan算法。
>
> 性能是算法选择的首要考量指标。

3. 特定场景，特殊优化

> 例如去重计数uniqCombined函数，会根据数据量的不同选择不同的算法：
>
> - 当数据量较小的时候，会选择Array保存
> - 当数据量中等的时候，会选择HashSet
> - 当数据量很大的时候，则使用HyperLogLog算法。
>
> 对于数据结构比较清晰的场景，会通过代码生成技术实现循环展开，以减少循环次数。
>
> 向量化执行
>
> SIMD被广泛地应用于文本转换、数据过滤、数据解压和JSON转换等场景。相较于单纯地使用CPU，利用寄存器暴力优化也算是一种降维打击了。

# 架构特性

多主对等网络架构(非常适合多数据中心、异地多活场景)，基于关系模型的ROLAP方案，MPP架构的列式存储数据库+数据压缩，向量化执行引擎

> 为了实现向量化执行，需要利用CPU的SIMD指令。SIMD的全称是Single Instruction Multiple Data，即用单条指令操作多条数据。现代计算机系统概念中，它是通过数据并行以提高性能的一种实现方式（其他的还有指令级并行和线程级并行），它的原理是在CPU寄存器层面实现数据的并行操作。
>
> ClickHouse目前利用SSE4.2指令集实现向量化执行。

多样化的表引擎，通过特定的表引擎支撑特定的场景更灵活；

多线程与分布式

> 利用分布式设计中分而治之的基本思想，如果一台服务器性能吃紧，那么就利用多台服务的资源协同处理。为了实现这一目标，首先需要在数据层面实现数据的分布式。在分布式领域，存在一条金科玉律——计算移动比数据移动更加划算。在各服务器之间，通过网络传输数据的成本是高昂的，所以相比移动数据，更为聪明的做法是预先将数据分布到各台服务器，将数据的计算查询直接下推到数据所在的服务器。
>
> ClickHouse在数据存取方面，既支持分区（纵向扩展，利用多线程原理），也支持分片（横向扩展，利用分布式原理），可以说是将多线程和分布式的技术应用到了极致。

数据分片与分布式查询

> 数据分片是将数据进行横向切分，这是一种在面对海量数据的场景下，解决存储和查询瓶颈的有效手段，是一种分治思想的体现。
>
> ClickHouse支持分片，而分片则依赖集群。每个集群由1到多个分片组成，而每个分片则对应了ClickHouse的1个服务节点。分片的数量上限取决于节点数量（1个分片只能对应1个服务节点）。则对应了ClickHouse的1个服务节点。分片的数量上限取决于节点数量（1个分片只能对应1个服务节点）。
>
> ClickHouse拥有高度自动化的分片功能。ClickHouse提供了本地表（LocalTable）与分布式表（Distributed Table）的概念。
>
> 这种设计类似数据库的分库和分表，十分灵活。例如在业务系统上线的初期，数据体量并不高，此时数据表并不需要多个分片。所以使用单个节点的本地表（单个数据分片）即可满足业务需求，待到业务增长、数据量增大的时候，再通过新增数据分片的方式分流数据，并通过分布式表实现分布式查询。



ClickHouse具备完备的DBMS功能，它具备下面这些基本功能：

- DDL（数据定义语言）：可以动态地创建、修改或删除数据库、表和视图，而无须重启服务。
- DML（数据操作语言）：可以动态查询、插入、修改或删除数据。
- 权限控制：可以按照用户粒度设置数据库或者表的操作权限，保障数据的安全性。
- 数据备份与恢复：提供了数据备份导出与导入恢复机制，满足生产环境的要求。
- 分布式管理：提供集群模式，能够自动管理多个数据库节点

# 架构设计



# 参考资料

1. ClickHouse原理解析与应用实践