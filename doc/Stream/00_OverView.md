# DAG(有向无环图)

从流式计算的计算任务拓扑结构角度来看，一般的流式计算任务都是由计算节点和流式数据组成的DAG。DAG中的顶点是算子，表示计算，边表示数据依赖关系。DAG的节点一般是完成一个计算任务所需要的各种处理功能，比如过滤、数值累加、Join等具体计算功能，而流经各个计算节点的实时数据流构成了DAG的有向边。

# 任务故障

<b><font color="orange">对于长期运行的流式作业，每个任务都谁是会出现故障，如何确保能够透明地处理这些故障，让流式作业可以继续运行。要实现这一点需要保证任务故障时可以继续运行，还需要保证结果和算子状态的正确性。</font></b>

对于流处理中的每个事件，任务都要执行以下几步：①接收事件并将它们存在本地缓冲区；②选择性更新内部状态；③产生输出记录。以上每步都可能发生故障，系统必须在故障情况下明确定义其行为。如果故障发生在第一步，事件是否会丢失？如果更新内部状态后发生故障，系统恢复后是否会重复更新？上述情况下，结果是否正确？



## 结果保障

结果保障指的是流处理引擎内部状态的一致性，也就是关注故障恢复后应用代码能够看到的状态。需要注意的是，保证应用状态的一致性和保证输出的一致性不是一回事。

---

**至多一次(At-Most Once Delivery)**

它保证每个事件至多被处理一次，也就是说没有机制来保证结果的正确性。上游节点不能保证消息被送达到下游节点。如果计算系统容错机制不完善，存在丢数据的可能性。`S4`和`MUDP8`属于这种类型。

---

 **至少一次(At-Least Once Delivery)**

对于大多数应用，用户不希望丢数据，这类保证称为至少一次。上游节点保证向下游节点送达一次或者多次相同的数据。所欲的数据都会被处理，但是有些数据可能会被处理多次。如果正确性仅依赖于信息的完整性，重复处理可以接受。例如，确定某个事件是否在输入流中出现过，可以采用至少一次保障正确实现；但如果要计算某个事件在输入流中出现的次数，至少一次保障会导致错误的计算结果。

为保证至少一次结果语义的正确性，需要在源头或缓冲区中去重。持久化时间日志会将所有的事件写入永久存储，这样可以在任务故障恢复时重放他们。一种实现方式是采用记录确认(record-acknowledgments)，它会将所有的数据都存在缓冲区中，直到处理管道中所有的任务都确认某个事件已经处理完毕才将数据丢弃。

---

**精确一次(Exact-Once Delivery)**

上游节点保证将流数据正确地送达下游节点且只正确送达一次。它表示没有数据的丢失，而且每个事件对于内部状态的更新都只有一次。本质上，精确一次保证意味着应用总会提供正确的结果如同故障没有发生过一样。`Storm`属于这种，它借助送达保证机制(实现至少送达一次)+事务拓扑(保证不会出现多次送达)联合完成。`Flink`也属于这种，它借助轻量级检查点机制来实现。

精确一致性保障以一次性保障为前提，同样需要数据重放，此外还需要流处理引擎保证内部状态的一致性，即在故障恢复后，引擎需要知道某个时间对应的更新是否已经反映在状态上。

---

**端到端的精确一次**

上面三个都属于应用状态的一致性。它在实际流处理中，处理流处理引擎还需要数据源组件和数据终点组件，端到端的精确一次指的是在整个数据管道上结果都是正确的。在每个组件都提供自身保证的情况下，整个数据管道上端到端保障受制于保障最弱的组件。在某些时候，可以借助弱保障来实现强语义，常见情况是求最大值或最小值的幂等操作，可以用至少一次保证来实现精确一次语义。

---

